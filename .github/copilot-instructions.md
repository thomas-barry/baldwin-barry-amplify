# Baldwin-Barry Amplify Photo Gallery Application

## Project Overview

This is a **React 18 + Vite + AWS Amplify Gen 2** full-stack application for managing photo galleries with image uploads, automatic thumbnail generation, EXIF metadata extraction, and admin controls. The application uses TypeScript throughout, with a focus on type safety, authentication via AWS Cognito, real-time data via GraphQL (AppSync), and cloud storage (S3).

**Key Technologies:**
- **Frontend**: React 18.2, Vite 6.3, TypeScript 5.4, TanStack Router 1.120, TanStack React Query 5.80
- **UI Framework**: PrimeReact 10.9 (with primeflex, primeicons)
- **Backend**: AWS Amplify Gen 2 (Infrastructure as Code with TypeScript/CDK)
- **Authentication**: Amazon Cognito (email-based login)
- **Database**: Amazon DynamoDB with AppSync GraphQL API
- **Storage**: Amazon S3 with automatic thumbnail generation
- **Image Processing**: Lambda functions with Sharp library

## Repository Structure

```
/
├── src/                          # Frontend React application
│   ├── components/               # Reusable React components
│   │   ├── GalleryList.tsx
│   │   ├── S3FileUploader/
│   │   ├── auth/ProtectedRoute.tsx
│   │   ├── navbar/NavBar.tsx
│   │   └── Card/                # Custom card component
│   ├── modules/                  # Feature modules
│   │   ├── galleries/           # Gallery management (main feature)
│   │   │   ├── components/      # Gallery-specific components
│   │   │   ├── hooks/           # Custom React hooks (useGalleryForm)
│   │   │   └── types/           # TypeScript type definitions
│   │   ├── home/                # Home page module
│   │   ├── login/               # Login page module
│   │   └── grid-demo/           # Demo components
│   ├── routes/                   # TanStack Router route definitions
│   │   ├── __root.tsx           # Root layout
│   │   ├── index.tsx            # Home route
│   │   ├── login.tsx            # Auth route
│   │   └── galleries/           # Gallery routes (list, detail, edit)
│   ├── context/                  # React Context (AuthContext)
│   ├── lib/                      # Utility libraries (s3-metadata-utils.ts)
│   ├── assets/                   # Static images
│   ├── routeTree.gen.ts          # Auto-generated by TanStack Router
│   ├── main.tsx                  # App entry point
│   └── index.css                 # Global styles
│
├── amplify/                      # AWS Amplify backend (TypeScript IaC)
│   ├── auth/                     # Cognito authentication resource
│   ├── data/                     # GraphQL schema & DynamoDB models
│   │   └── resource.ts          # Defines Gallery, Image, GalleryImage models
│   ├── storage/                  # S3 bucket configuration
│   ├── functions/                # Lambda functions
│   │   ├── onUploadHandler/     # S3 upload trigger → thumbnail generation
│   │   └── deleteGalleryWithImages/  # Delete handler
│   ├── backend.ts                # Backend definition & IAM grants
│   ├── package.json              # Backend dependencies
│   └── tsconfig.json             # Backend TypeScript config
│
├── .github/                      # GitHub configuration
│   ├── copilot-instructions.md   # This file
│   └── general-coding.instructions.md  # Path-specific instructions
│
├── Configuration Files (Root)
│   ├── package.json              # Dependencies & npm scripts
│   ├── tsconfig.json             # Frontend TypeScript config
│   ├── tsconfig.base.json        # Shared TypeScript base config
│   ├── vite.config.ts            # Vite build configuration
│   ├── amplify.yml               # AWS Amplify deployment config
│   ├── eslint.config.js          # ESLint 9 flat config (strict)
│   ├── prettier.config.js        # Prettier formatting config
│   ├── constants.ts              # Global constants
│   └── index.html                # HTML entry point
```

## Build, Test & Development

### Prerequisites

**ALWAYS** ensure you have the following before starting development:
1. AWS CLI configured with appropriate permissions
2. AWS SSO login: `aws sso login --profile bb-admin`
3. Node.js and npm installed

### Development Workflow

**The correct order to start development is:**

1. **Start Amplify Sandbox** (backend services):
   ```bash
   npx ampx sandbox
   ```
   - This generates `amplify_outputs.json` which is **required** for the frontend to work
   - Wait for the sandbox to fully deploy before starting the frontend
   - Keep this running in a separate terminal

2. **Start Development Server** (frontend):
   ```bash
   npm run dev
   ```
   - Opens on http://localhost:5173 by default
   - Hot module replacement (HMR) enabled

**IMPORTANT**: The frontend build will fail with `Cannot find module '../amplify_outputs.json'` if the Amplify sandbox has not been run first. This is expected and not an error in the code.

### Available Commands

| Command | Purpose | Notes |
|---------|---------|-------|
| `npm install` | Install dependencies | **ALWAYS** run after cloning or pulling changes |
| `npm run dev` | Start dev server | Requires amplify_outputs.json from sandbox |
| `npm run build` | Type-check + build | Runs `tsc && vite build` |
| `npm run lint` | Run ESLint | **Zero warnings allowed** (--max-warnings 0) |
| `npm run preview` | Preview production build | Must run build first |
| `npm run cleanup` | Clear DynamoDB & S3 data | ⚠️ Destructive, dev only |
| `npx ampx sandbox` | Start AWS Amplify backend | Generates amplify_outputs.json |

### Build Configuration

- **TypeScript**: Strict mode enabled, requires explicit types
- **ESLint**: Flat config (v9+) with strict rules, zero warnings policy
- **Prettier**: 2-space indentation, 120 char width, single quotes
- **Vite**: Uses React plugin, TanStack Router plugin, Lightning CSS

### Path Aliases

Use these TypeScript path aliases for imports:
```typescript
@/components  → src/components
@/modules     → src/modules
@/context     → src/context
@/lib         → src/lib
@/assets      → src/assets
@/routes      → src/routes
```

## Data Models (GraphQL Schema)

Located in `amplify/data/resource.ts`:

```typescript
Gallery {
  id: ID!
  name: String!
  description: String
  createdDate: AWSDateTime!
  thumbnailImageId: ID
  thumbnailImage: Image @belongsTo
  images: [GalleryImage] @hasMany
}

Image {
  id: ID!
  title: String
  description: String
  s3Key: String!
  s3ThumbnailKey: String
  uploadDate: AWSDateTime!
  fileName: String!
  fileSize: Int
  width: Int
  height: Int
  contentType: String
  tags: [String]
  exifData: AWSJSON
  galleries: [GalleryImage] @hasMany
  thumbnailForGallery: Gallery @hasOne
}

GalleryImage {
  id: ID!
  galleryId: ID!
  imageId: ID!
  addedDate: AWSDateTime!
  order: Int!
  gallery: Gallery @belongsTo
  image: Image @belongsTo
}
```

**Authorization Rules**:
- Public read access via API Key
- `admin` group for create/update/delete operations
- Defined in each model's `authorization` rules

## Lambda Functions

### onUploadHandler
- **Trigger**: S3 object creation in `uploads/*` prefix
- **Purpose**: Generate thumbnails, extract EXIF metadata, update DynamoDB
- **Dependencies**: Sharp layer (ARN: arn:aws:lambda:us-east-1:217260976694:layer:sharp:4)
- **Outputs**: Thumbnail saved to `thumbnails/*` prefix

### deleteGalleryWithImages
- **Trigger**: Custom invocation
- **Purpose**: Cascade delete gallery and related images from DynamoDB and S3

## Deployment

Deployment is handled via AWS Amplify Console using `amplify.yml`:

**Backend Phase**:
```bash
npm ci --cache .npm --prefer-offline
npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
```

**Frontend Phase**:
```bash
npm run build
# Outputs to dist/ directory
```

Both phases use npm caching for faster builds.

## Common Issues & Solutions

### "Cannot find module '../amplify_outputs.json'"
- **Cause**: Amplify sandbox not running
- **Solution**: Run `npx ampx sandbox` first, wait for deployment to complete

### Build fails with TypeScript errors
- **Cause**: Missing dependencies or type declarations
- **Solution**: Run `npm install` to ensure all dependencies are installed

### ESLint warnings causing build failures
- **Cause**: Zero warnings policy in lint script
- **Solution**: Fix all ESLint warnings, don't suppress them unless absolutely necessary

### S3 upload fails or thumbnails not generating
- **Cause**: Lambda function errors or missing permissions
- **Solution**: Check Lambda logs in AWS CloudWatch, verify IAM permissions in `amplify/backend.ts`

## Coding Standards

### Naming Conventions
- Use **PascalCase** for component names, interfaces, and type aliases
- Use **camelCase** for variables, functions, and methods
- Prefix private class members with underscore (`_`)
- Use **ALL_CAPS** for constants
- Component folder names should be **kebab-case**

### TypeScript Guidelines
- Use TypeScript for all new code
- Follow functional programming principles where possible
- Use interfaces for data structures and type definitions
- Prefer immutable data (`const`, `readonly`)
- Use optional chaining (`?.`) and nullish coalescing (`??`) operators
- Avoid `any` type, use `unknown` if type is truly unknown

### React Guidelines
- Use **functional components** with hooks (no class components)
- Follow React hooks rules (no conditional hooks, hooks at top level)
- Use `React.FC` type for components with children
- Keep components small and focused (single responsibility)
- Use CSS modules for component-specific styling
- Implement error boundaries for error handling

### Error Handling
- Use try/catch blocks for async operations
- Implement proper error boundaries in React components
- Always log errors with contextual information
- Provide user-friendly error messages

## Key Features & Routes

| Route | Component | Access | Purpose |
|-------|-----------|--------|---------|
| `/` | Home.tsx | Public | Landing page |
| `/login` | LoginPage.tsx | Public | Cognito authentication |
| `/galleries` | Galleries.tsx | Authenticated | List all galleries |
| `/galleries/:galleryId` | Gallery.tsx | Authenticated | View gallery detail |
| `/galleries/:galleryId/edit` | GalleryEditor.tsx | Admin | Edit gallery & manage images |
| `/admin` | Admin panel | Admin | Admin-only features |
| `/grid-demo` | GridDemo.tsx | Public | Demo component |

Protected routes use `ProtectedRoute.tsx` wrapper component.

## Additional Context

- **Image Handling**: Automatic thumbnail generation on upload via Lambda with Sharp
- **EXIF Extraction**: Camera metadata automatically extracted and stored in `Image.exifData`
- **Development Data**: Use `npm run cleanup` to clear DynamoDB and S3 data during development
- **Code Quality**: Pre-commit hooks should format code with Prettier and check with ESLint
- **AWS Resources**: All AWS resources are defined as code in the `amplify/` directory

## Validation Steps

Before submitting code changes:

1. **Run linter**: `npm run lint` (must pass with zero warnings)
2. **Type-check**: `npm run build` (TypeScript compilation must succeed)
3. **Test locally**: Start sandbox and dev server, verify functionality
4. **Check formatting**: Code should be formatted with Prettier
5. **Verify no sensitive data**: Never commit AWS credentials or secrets

## Important Notes

- Never commit `amplify_outputs.json` - it's generated per environment
- Never commit `.env` files or AWS credentials
- The `node_modules/` and `.aws-sam/` directories are gitignored
- S3 bucket uses `uploads/` and `thumbnails/` prefixes for organization
- Authentication uses email/password via Cognito User Pools
- Admin users must be manually added to the `admin` group in Cognito
